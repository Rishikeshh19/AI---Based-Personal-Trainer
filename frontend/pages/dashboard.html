<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Personal Trainer Assistant</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/professional.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/dark-mode.css">
    <script>
        // Check authentication immediately
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/pages/login.html';
            }
        })();
    </script>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" style="text-decoration: none; color: inherit; cursor: pointer;">
                <h1>AI Trainer</h1>
            </a>
            <button class="sidebar-toggle" type="button" aria-label="Toggle sidebar" title="Toggle sidebar">
                <span class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </button>
        </div>
        <nav>
            <ul>
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="muscle-workout.html" class="nav-link">Muscle Workout</a></li>
                <li><a href="select-trainer.html" class="nav-link">Select Trainer</a></li>
                <li><a href="messages.html" class="nav-link">Messages</a></li>
                <li><a href="notifications.html" class="nav-link">Notifications</a></li>
                <li><a href="ai-suggestions.html" class="nav-link">AI Suggestions</a></li>
                <li id="diet-plan-item"><a href="diet-plan.html" class="nav-link">AI Diet Plan</a></li>
                <li><a href="progress.html" class="nav-link">View Progress</a></li>
                <li><a href="profile.html" class="nav-link">Profile</a></li>
                <li><a href="#" class="nav-link" id="logout-link">Logout</a></li>
            </ul>
        </nav>
    </div>

    <main>
        <!-- Stats Cards -->
        <div class="dashboard-container">
            <div class="stats-card">
                <div class="card-icon"></div>
                <h3>Total Workouts</h3>
                <div class="stat-value" id="total-workouts">0</div>
                <p>This month</p>
            </div>
            <div class="stats-card">
                <div class="card-icon"></div>
                <h3>Calories Burned</h3>
                <div class="stat-value" id="total-calories">0</div>
                <p>Total</p>
            </div>
            <div class="stats-card">
                <div class="card-icon"></div>
                <h3>Streak</h3>
                <div class="stat-value" id="streak">0</div>
                <p>Days active</p>
            </div>
            <div class="stats-card">
                <div class="card-icon"></div>
                <h3>Goal Progress</h3>
                <div class="stat-value" id="goal-progress">75%</div>
                <p>This week</p>
            </div>
        </div>

        <!-- Latest Workout Section -->
        <section id="workout-summary">
            <h2>Latest Workout</h2>
            <div id="latest-workout" class="empty-state">
                <h3>No workouts recorded yet</h3>
                <p>Start your fitness journey by logging your first workout</p>
                <a href="muscle-workout.html" class="button">Select Muscle & Train</a>
            </div>
        </section>

        <!-- Your Trainer Section (Members Only) -->
        <section id="your-trainer-section"
            style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 10px; text-align: left; display: none;">
            <h2>Your Trainer</h2>
            <div id="your-trainer-container" class="empty-state" style="text-align: center;">
                <p>No trainer selected yet. Visit <a href="select-trainer.html" style="color: #1E40AF; text-decoration: underline;">Select Trainer</a> to choose one.</p>
            </div>
        </section>

        <!-- Progress Report Section -->
        <section id="progress-report">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Progress Report - This Week</h2>
                <a href="progress.html" class="button" style="padding: 8px 16px; background: #1E40AF; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; transition: all 0.3s; display: inline-block;">View More →</a>
            </div>
            <div id="progress-container">
                <div class="empty-state">
                    <h3>No workouts this week</h3>
                    <p>Start logging workouts to see your progress here</p>
                </div>
            </div>
        </section>
    </main>

    <div class="footer">
        <p>&copy; 2025 AI Personal Trainer Assistant. All rights reserved.</p>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/nav.js"></script>
    <script src="../js/dark-mode.js"></script>
    <script src="../js/api.js"></script>
    <script src="http://localhost:8000/socket.io/socket.io.js"></script>
    <script src="../js/dashboard.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const token = storage.getToken();
            if (!token) {
                window.location.href = "login.html";
                return;
            }

            const currentUser = storage.getCurrentUser();
            if (!currentUser) {
                window.location.href = "login.html";
                return;
            }

            // Show/hide sections based on role (no redirects, keep dashboard static)
            if (currentUser.role === 'member') {
                const yourTrainerSection = document.getElementById('your-trainer-section');
                if (yourTrainerSection) yourTrainerSection.style.display = 'block';

                // Load trainer info into dashboard section
                loadYourTrainer();
            } else if (currentUser.role === 'trainer') {
                const aiSection = document.getElementById('ai-suggestions');
                // Hide AI suggestions section for trainers
                if (aiSection) aiSection.style.display = 'none';
            }

            const logoutLink = document.getElementById("logout-link");
            if (logoutLink) {
                logoutLink.addEventListener("click", function (e) {
                    e.preventDefault();
                    // Clear session from localStorage
                    localStorage.removeItem('token');
                    localStorage.removeItem('current_user');
                    localStorage.removeItem('isProfileComplete');
                    // Redirect to login
                    window.location.href = '/pages/login.html';
                });
            }
        });

        async function loadYourTrainer() {
            const container = document.getElementById('your-trainer-container');
            if (!container) return;

            try {
                // Fetch current trainer info from API
                const response = await api.member.getCurrentTrainer();
                
                if (!response || !response.data || !response.data._id) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No trainer selected</h3>
                            <p>Visit <a href="select-trainer.html" style="color: #1E40AF; text-decoration: underline;">Select Trainer</a> to choose one.</p>
                        </div>
                    `;
                    return;
                }

                // Display selected trainer info
                const trainer = response.data;
                const firstName = trainer.profile?.firstName || 'Trainer';
                const lastName = trainer.profile?.lastName || '';
                const fullName = `${firstName} ${lastName}`.trim();
                const specialization = trainer.profile?.specialization || 'Personal Trainer';

                container.innerHTML = `
                    <div class="card" style="text-align: center;">
                        <h3 style="margin-bottom: 8px;">${fullName}</h3>
                        <p style="margin-bottom: 12px; color:#555;">${specialization}</p>
                        <a href="messages.html" class="button" style="padding: 8px 16px; font-size: 13px; background: #1E40AF; color: white; text-decoration: none; display: inline-block; border-radius: 5px;">Send Message</a>
                    </div>
                `;
            } catch (error) {
                console.log('Error loading trainer:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No trainer selected</h3>
                        <p>Visit <a href="select-trainer.html" style="color: #1E40AF; text-decoration: underline;">Select Trainer</a> to choose one.</p>
                    </div>
                `;
            }
        }

        // Filter button handling for progress report
        document.addEventListener('DOMContentLoaded', function() {
            loadWeeklyProgress();
        });

        async function loadWeeklyProgress() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8000/api/progress?filter=weekly', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch progress');
                
                const data = await response.json();
                displayWeeklyProgress(data.workouts);
            } catch (error) {
                console.error('Error loading progress:', error);
                document.getElementById('progress-container').innerHTML = `
                    <div class="empty-state">
                        <h3>Unable to load progress</h3>
                        <p>Please try again later</p>
                    </div>
                `;
            }
        }

        function displayWeeklyProgress(workouts) {
            const container = document.getElementById('progress-container');
            
            if (!workouts || workouts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No workouts this week</h3>
                        <p>Start logging workouts to see your progress here</p>
                    </div>
                `;
                return;
            }

            let html = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">`;
            
            workouts.slice(0, 3).forEach(workout => {
                const date = new Date(workout.date).toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                const muscles = workout.exercises?.map(e => e.name || e).join(', ') || 'Mixed';
                
                html += `
                    <div style="background: linear-gradient(135deg, #1E40AF 0%, #0891B2 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(90, 0, 255, 0.2);">
                        <h4 style="margin: 0 0 10px 0;">${date}</h4>
                        <p style="margin: 8px 0; font-size: 14px;"><strong>Muscles:</strong> ${muscles}</p>
                        <p style="margin: 8px 0; font-size: 14px;"><strong>Duration:</strong> ${workout.totalDuration || 0} mins</p>
                        <p style="margin: 8px 0; font-size: 14px;"><strong>Calories:</strong> ${workout.totalCalories || 0} cal</p>
                    </div>
                `;
            });

            html += `</div>`;
            
            if (workouts.length > 3) {
                html += `
                    <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                        Showing 3 of ${workouts.length} workouts this week. <a href="progress.html" style="color: #1E40AF; text-decoration: underline;">View all →</a>
                    </p>
                `;
            }

            container.innerHTML = html;
        }
    </script>
</body>

</html>
