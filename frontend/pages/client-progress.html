<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Progress - AI Personal Trainer</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/professional.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Check authentication immediately
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            }
        })();
    </script>
    <style>
        .progress-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .client-selector {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.1);
            border: 2px solid #E0F2FE;
        }

        .client-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1E40AF;
        }

        .client-selector select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E0F2FE;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            background: #F8FAFC;
            color: #0F172A;
        }

        .client-selector select:focus {
            border-color: #1E40AF;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #FFFFFF;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.1);
            text-align: center;
            border: 2px solid #E0F2FE;
        }

        .stat-card .icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #1E40AF;
            margin: 8px 0;
        }

        .stat-card .label {
            color: #64748B;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #FFFFFF;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.1);
            border: 2px solid #E0F2FE;
        }

        .chart-card h3 {
            margin: 0 0 20px 0;
            color: #1E40AF;
            font-size: 18px;
        }

        .workout-log {
            background: #FFFFFF;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.1);
            border: 2px solid #E0F2FE;
        }

        .workout-log h3 {
            margin: 0 0 20px 0;
            color: #1E40AF;
        }

        .workout-entry {
            padding: 16px;
            border-left: 4px solid #1E40AF;
            background: #F0F9FF;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .workout-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .workout-date {
            font-weight: 600;
            color: #1E40AF;
        }

        .workout-calories {
            background: #1E40AF;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .workout-exercises {
            color: #475569;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" style="text-decoration: none; color: inherit; cursor: pointer;">
                <h1>AI Trainer</h1>
            </a>
            <button class="sidebar-toggle" type="button" aria-label="Toggle sidebar" title="Toggle sidebar">
                <span class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </button>
        </div>
        <nav>
            <ul id="navList">
                <!-- Navigation items will be populated by nav.js -->
            </ul>
        </nav>
    </div>

    <main>
        <h1>Client Progress</h1>
        <p style="color: #666; margin-bottom: 30px;">Track and analyze your clients' fitness journey</p>

        <div class="progress-container">
            <div class="client-selector">
                <label for="clientSelect">Select Client:</label>
                <select id="clientSelect">
                    <option value="">Loading clients...</option>
                </select>
            </div>

            <div id="progressContent" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon">Analytics</div>
                        <div class="value" id="totalWorkouts">0</div>
                        <div class="label">Total Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">Calories</div>
                        <div class="value" id="totalCalories">0</div>
                        <div class="label">Calories Burned</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">Time</div>
                        <div class="value" id="avgDuration">0</div>
                        <div class="label">Avg Duration (min)</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">Schedule</div>
                        <div class="value" id="lastWorkout">N/A</div>
                        <div class="label">Last Workout</div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <h3>Workout Frequency (Last 7 Days)</h3>
                        <canvas id="frequencyChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Calories Burned Trend</h3>
                        <canvas id="caloriesChart"></canvas>
                    </div>
                </div>

                <div class="workout-log">
                    <h3>Recent Workouts</h3>
                    <div id="workoutLog">
                        <div class="empty-state">
                            <p>No workout history available</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="emptyState" class="empty-state">
                <h3>Select a client above to view their progress</h3>
            </div>
        </div>
    </main>

    <script src="../js/clear-old-tokens.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/nav.js"></script>
    <script src="../js/api.js"></script>
    <script>
        let frequencyChart = null;
        let caloriesChart = null;

        document.addEventListener("DOMContentLoaded", function () {
            const token = storage.getToken();
            if (!token) {
                window.location.href = "login.html";
                return;
            }

            const currentUser = storage.getCurrentUser();
            if (!currentUser || currentUser.role !== 'trainer') {
                alert('This page is for trainers only');
                window.location.href = 'dashboard.html';
                return;
            }

            const logoutLink = document.getElementById("logout-link");
            if (logoutLink) {
                logoutLink.addEventListener("click", function (e) {
                    e.preventDefault();
                    if (typeof logout === 'function') {
                        logout();
                    } else {
                        storage.clearSession();
                        window.location.href = 'login.html';
                    }
                });
            }

            loadClientsList();
        });

        async function loadClientsList() {
            const select = document.getElementById('clientSelect');

            try {
                const response = await api.trainer.getAssignedClients();
                const clients = response.data || [];

                if (clients.length === 0) {
                    select.innerHTML = '<option value="">No clients assigned</option>';
                    return;
                }

                select.innerHTML = '<option value="">-- Select a client --</option>';
                clients.forEach(client => {
                    const firstName = client.profile?.firstName || 'Client';
                    const lastName = client.profile?.lastName || '';
                    const fullName = `${firstName} ${lastName}`.trim();

                    const option = document.createElement('option');
                    option.value = client._id;
                    option.textContent = fullName;
                    select.appendChild(option);
                });

                select.addEventListener('change', function () {
                    if (this.value) {
                        loadClientProgress(this.value);
                    } else {
                        document.getElementById('progressContent').style.display = 'none';
                        document.getElementById('emptyState').style.display = 'block';
                    }
                });
            } catch (error) {
                console.error('Error loading clients:', error);
                select.innerHTML = '<option value="">Error loading clients</option>';
            }
        }

        async function loadClientProgress(clientId) {
            try {
                const response = await api.trainer.getClientDetails(clientId);
                const data = response.data;
                const stats = data.stats || {};

                document.getElementById('progressContent').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';

                // Update stats
                document.getElementById('totalWorkouts').textContent = stats.totalWorkouts || 0;
                document.getElementById('totalCalories').textContent = (stats.totalCalories || 0).toLocaleString();
                document.getElementById('avgDuration').textContent = Math.round(stats.avgDurationPerWorkout || 0);

                const recentWorkouts = stats.recentWorkouts || [];
                if (recentWorkouts.length > 0) {
                    const lastWorkoutDate = new Date(recentWorkouts[0].date);
                    document.getElementById('lastWorkout').textContent = lastWorkoutDate.toLocaleDateString();
                } else {
                    document.getElementById('lastWorkout').textContent = 'N/A';
                }

                // Update charts
                updateCharts(recentWorkouts);

                // Update workout log
                updateWorkoutLog(recentWorkouts);
            } catch (error) {
                console.error('Error loading client progress:', error);
                alert('Failed to load client progress');
            }
        }

        function updateCharts(workouts) {
            // Get last 7 days
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            }

            // Count workouts per day
            const workoutCounts = new Array(7).fill(0);
            workouts.forEach(workout => {
                const workoutDate = new Date(workout.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const index = last7Days.indexOf(workoutDate);
                if (index !== -1) {
                    workoutCounts[index]++;
                }
            });

            // Frequency Chart
            const freqCtx = document.getElementById('frequencyChart');
            if (frequencyChart) frequencyChart.destroy();
            frequencyChart = new Chart(freqCtx, {
                type: 'bar',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Workouts',
                        data: workoutCounts,
                        backgroundColor: '#1E40AF',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Calories Chart
            const caloriesData = workouts.slice(0, 10).reverse().map(w => w.totalCalories || 0);
            const caloriesLabels = workouts.slice(0, 10).reverse().map(w =>
                new Date(w.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            );

            const calCtx = document.getElementById('caloriesChart');
            if (caloriesChart) caloriesChart.destroy();
            caloriesChart = new Chart(calCtx, {
                type: 'line',
                data: {
                    labels: caloriesLabels,
                    datasets: [{
                        label: 'Calories',
                        data: caloriesData,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateWorkoutLog(workouts) {
            const logContainer = document.getElementById('workoutLog');

            if (workouts.length === 0) {
                logContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No workout history available</p>
                    </div>
                `;
                return;
            }

            logContainer.innerHTML = '';
            workouts.slice(0, 10).forEach(workout => {
                const entry = document.createElement('div');
                entry.className = 'workout-entry';
                entry.innerHTML = `
                    <div class="workout-entry-header">
                        <div class="workout-date">${new Date(workout.date).toLocaleDateString()}</div>
                        <div class="workout-calories">${workout.totalCalories || 0} cal</div>
                    </div>
                    <div class="workout-exercises">
                        ${workout.exercises?.length || 0} exercises completed
                        ${workout.exercises && workout.exercises.length > 0 ? 'â€¢ ' + workout.exercises.map(e => e.name).join(', ') : ''}
                    </div>
                `;
                logContainer.appendChild(entry);
            });
        }
    </script>
</body>

</html>
